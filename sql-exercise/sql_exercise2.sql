DROP DATABASE IF EXISTS ORG;
CREATE DATABASE ORG;
-- SHOW DATABASES;
USE ORG;

DROP TABLE IF EXISTS WORKER;
CREATE TABLE WORKER (
	WORKER_ID INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
    FIRST_NAME CHAR(25),
    LAST_NAME CHAR(25),
    SALARY NUMERIC(15),
    JOINING_DATE DATETIME,
    DEPARTMENT CHAR(25)
);

INSERT INTO WORKER
  (FIRST_NAME, LAST_NAME, SALARY, JOINING_DATE, DEPARTMENT) VALUES
	('Monika', 'Arora', 100000, '21-02-20 09:00:00', 'HR'),
    ('Niharika', 'Verma', 80000, '21-06-11 09:00:00', 'Admin'),
    ('Vishal', 'Singhal', 300000, '12-02-20 09:00:00', 'HR'),
    ('Mohan', 'Sarah', 300000, '21-03-19 09:00:00', 'Admin'),
    ('Amitabh', 'Singh', 500000, '21-02-20 09:00:00', 'Admin'),
    ('Vivek', 'Bhati', 490000, '21-06-11 09:00:00', 'Admin'),
    ('Vipul', 'Diwan', 200000, '21-06-11 09:00:00', 'Account'),
    ('Satish', 'Kumar', 75000, '21-01-20 09:00:00', 'Account'),
    ('Geetika', 'Chauhan', 90000, '21-04-11 09:00:00', 'Admin');
    
SELECT * FROM WORKER;

CREATE TABLE BONUS (
	WORKER_REF_ID INTEGER,
	BONUS_AMOUNT NUMERIC(10),
	BONUS_DATE DATETIME,
	FOREIGN KEY (WORKER_REF_ID) REFERENCES WORKER(WORKER_ID)
);

-- Task 1
INSERT INTO BONUS VALUES
	(6, 32000, '21-11-02'),
    (6, 20000, '22-11-02'),
    (5, 21000, '21-11-02'),
    (9, 30000, '21-11-02'),
    (8, 4500, '22-11-02');
    
-- Task 2
SELECT SALARY
FROM (
	SELECT SALARY, RANK() OVER(ORDER BY SALARY DESC) AS SALARY_RANK
	FROM WORKER
    GROUP BY SALARY
) AS RANKED
WHERE SALARY_RANK = 2;

-- Task 3
WITH CTE AS (
	SELECT *, RANK() OVER(PARTITION BY DEPARTMENT ORDER BY SALARY DESC) AS RANKING
	FROM WORKER
)
SELECT DEPARTMENT, FIRST_NAME, LAST_NAME
FROM CTE
WHERE RANKING = 1;

-- Task 4
SELECT W1.FIRST_NAME, W1.LAST_NAME, W1.SALARY
FROM WORKER W1 INNER JOIN WORKER W2 ON W1.SALARY = W2.SALARY AND W1.WORKER_ID <> W2.WORKER_ID;

-- Task 5
SELECT W.FIRST_NAME, W.LAST_NAME, W.SALARY + IF(YEAR(B.BONUS_DATE) = '2021', B.BONUS_AMOUNT, 0) AS TOTAL_SALARY
FROM WORKER W LEFT JOIN BONUS B ON W.WORKER_ID = B.WORKER_REF_ID
WHERE YEAR(B.BONUS_DATE) = '2021' OR B.BONUS_DATE IS NULL;

DELETE FROM WORKER;

DROP TABLE WORKER;